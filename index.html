<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½æº«æ¿•åº¦è¨ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .temp-gradient-text { background-clip: text; -webkit-background-clip: text; color: transparent; }
        .chart-container { position: relative; height: 180px; width: 100%; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .history-btn.active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen">

    <!-- æ‰‹æ©Ÿè¢å¹•æ¨¡æ“¬ -->
    <div class="w-full max-w-sm h-[85vh] max-h-[800px] min-h-[680px] mx-auto bg-gray-50 rounded-3xl shadow-2xl overflow-hidden flex flex-col">
        
        <!-- **é‡æ–°è¨­è¨ˆçš„ä½ˆå±€** -->
        <main id="main-container" class="flex flex-col h-full transition-all duration-1000 ease-in-out">
            
            <!-- é ‚éƒ¨æ¨™é¡Œ (å›ºå®šé«˜åº¦) -->
            <header class="p-6 flex justify-between items-center flex-shrink-0">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">æˆ‘çš„æˆ¿é–“</h1>
                    <p id="date-time" class="text-sm text-gray-500">æ­£åœ¨è¼‰å…¥æ—¥æœŸ...</p>
                </div>
                <div class="w-10 h-10 bg-white/50 rounded-full flex items-center justify-center shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                </div>
            </header>

            <!-- å³æ™‚æ•¸æ“šé¡¯ç¤º (å½ˆæ€§å¡«æ»¿å‰©é¤˜ç©ºé–“) -->
            <section class="flex-grow flex flex-col items-center justify-center text-center px-6 min-h-0">
                <div id="temp-display" class="relative w-48 h-48 rounded-full flex items-center justify-center shadow-inner transition-all duration-1000 ease-in-out flex-shrink-0">
                    <div class="absolute inset-0 rounded-full shadow-xl"></div>
                    <div class="z-10">
                        <p class="font-bold text-6xl temp-gradient-text" id="current-temp">--.-</p>
                        <p class="font-medium text-lg text-gray-600">Â°C</p>
                    </div>
                </div>
                <div class="mt-8 text-lg font-medium text-gray-700"><p>æ¿•åº¦: <span id="current-humidity" class="font-bold">--</span>%</p></div>
                <div class="mt-2 text-sm text-gray-500"><p id="status-text">æ­£åœ¨é€£æ¥æ„Ÿæ‡‰å™¨...</p></div>
                <div class="mt-6"><button id="gemini-btn" class="px-6 py-2 bg-white/80 backdrop-blur-sm text-gray-700 font-semibold rounded-full shadow-md hover:bg-white transition-all transform hover:scale-105">âœ¨ ç²å–æ™ºèƒ½å»ºè­°</button></div>
            </section>

            <!-- æ­·å²æ•¸æ“šåœ–è¡¨ (å›ºå®šé«˜åº¦) -->
            <section class="p-6 pt-0 flex-shrink-0">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-gray-800">æ­·å²æ•¸æ“š</h2>
                    <button id="gemini-trend-btn" class="px-4 py-1 text-xs bg-white/70 backdrop-blur-sm text-gray-600 font-semibold rounded-full shadow-sm hover:bg-white transition-all">âœ¨ åˆ†æè¶¨å‹¢</button>
                </div>
                <div class="p-4 bg-white/60 rounded-2xl shadow-md backdrop-blur-sm">
                    <div class="chart-container"><canvas id="historyChart"></canvas></div>
                    <div id="history-controls" class="mt-3 flex justify-center space-x-2">
                        <button class="history-btn px-3 py-1 text-xs bg-gray-200 text-gray-600 font-semibold rounded-full hover:bg-gray-300 transition-all" data-timespan="hour">éå» 1 å°æ™‚</button>
                        <button class="history-btn px-3 py-1 text-xs bg-gray-200 text-gray-600 font-semibold rounded-full hover:bg-gray-300 transition-all" data-timespan="day">éå» 24 å°æ™‚</button>
                        <button id="live-btn" class="history-btn px-3 py-1 text-xs bg-gray-200 text-gray-600 font-semibold rounded-full hover:bg-gray-300 transition-all active">ğŸ”´ å³æ™‚</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Gemini å»ºè­°æ¨¡æ…‹æ¡† -->
    <div id="gemini-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white/90 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center">
            <div id="gemini-content"></div>
            <button id="close-modal-btn" class="mt-6 bg-gray-200 text-gray-700 px-8 py-2 rounded-full font-semibold hover:bg-gray-300 transition-all">é—œé–‰</button>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const FUNCTION_APP_URL = 'https://my-temp-hub-functions-2025.azurewebsites.net'; 
    // --- END CONFIGURATION ---

    // --- DOM å…ƒç´  ---
    const mainContainer = document.getElementById('main-container');
    const tempDisplay = document.getElementById('temp-display');
    const currentTempEl = document.getElementById('current-temp');
    const currentHumidityEl = document.getElementById('current-humidity');
    const statusTextEl = document.getElementById('status-text');
    const dateTimeEl = document.getElementById('date-time');
    const geminiBtn = document.getElementById('gemini-btn');
    const geminiTrendBtn = document.getElementById('gemini-trend-btn');
    const geminiModal = document.getElementById('gemini-modal');
    const geminiContent = document.getElementById('gemini-content');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const historyControls = document.getElementById('history-controls');
    const liveBtn = document.getElementById('live-btn');

    let historyChart;
    let currentTemp = 25.3;
    let currentHumidity = 58;
    let isLiveMode = true;

    // --- æ ¸å¿ƒåŠŸèƒ½ (æ­¤è™•çœç•¥éƒ¨åˆ†å‡½å¼ä»¥ä¿æŒç°¡æ½”) ---
    function updateAppearance(temp) { /* ... */ }
    function updateChartScales(chart, tempData, humidityData) { /* ... */ }
    function setupChart() { /* ... */ }
    function updateDateTime() { /* ... */ }
    async function callGemini(prompt, title) { /* ... */ }
    function getGeminiSuggestion() { /* ... */ }
    function getGeminiTrendAnalysis() { /* ... */ }
    
    // çœç•¥çš„å‡½å¼å®šç¾©
    updateAppearance = (temp) => { let bgColor, shadowColor, gradientFrom, gradientTo, statusText; const tempMin = 15, tempMax = 35, hueMin = 220, hueMax = 0; const clampedTemp = Math.max(tempMin, Math.min(tempMax, temp)); const tempRatio = (clampedTemp - tempMin) / (tempMax - tempMin); const hue = hueMin - (hueMin - hueMax) * tempRatio; const lightness = temp > 28 ? 85 : 95; const saturation = temp > 28 ? 65 : 60; bgColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`; shadowColor = `hsl(${hue}, ${saturation-10}%, ${lightness-10}%)`; gradientFrom = `hsl(${hue}, 80%, 60%)`; gradientTo = `hsl(${(hue + 30) % 360}, 80%, 50%)`; if (temp > 30) statusText = "æœ‰é»ç†±"; else if (temp > 28) statusText = "å¤©æ°£æº«æš–"; else if (temp < 18) statusText = "æœ‰é»æ¶¼"; else statusText = "é«”æ„Ÿèˆ’é©"; mainContainer.style.backgroundColor = bgColor; tempDisplay.style.backgroundColor = `hsl(${hue}, ${saturation}%, 98%)`; tempDisplay.style.boxShadow = `0 0 40px ${shadowColor}`; currentTempEl.style.backgroundImage = `linear-gradient(45deg, ${gradientFrom}, ${gradientTo})`; statusTextEl.textContent = statusText; };
    updateChartScales = (chart, tempData, humidityData) => { if (!tempData || tempData.length < 2) return; const tempMin = Math.min(...tempData); const tempMax = Math.max(...tempData); const humidityMin = Math.min(...humidityData); const humidityMax = Math.max(...humidityData); const tempPadding = (tempMax - tempMin) * 0.2 || 0.5; const humidityPadding = (humidityMax - humidityMin) * 0.2 || 2; chart.options.scales.y_temp.min = Math.floor(tempMin - tempPadding); chart.options.scales.y_temp.max = Math.ceil(tempMax + tempPadding); chart.options.scales.y_humidity.min = Math.floor(humidityMin - humidityPadding); chart.options.scales.y_humidity.max = Math.ceil(humidityMax + humidityPadding); };
    setupChart = () => { const ctx = document.getElementById('historyChart').getContext('2d'); historyChart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label: 'æº«åº¦ (Â°C)', data: [], borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.1)', fill: true, tension: 0.4, yAxisID: 'y_temp', }, { label: 'æ¿•åº¦ (%)', data: [], borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.1)', fill: true, tension: 0.4, yAxisID: 'y_humidity', }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { x: { grid: { display: false } }, y_temp: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'æº«åº¦ (Â°C)', color: 'rgb(255, 99, 132)' }, ticks: { color: 'rgb(255, 99, 132)' } }, y_humidity: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'æ¿•åº¦ (%)', color: 'rgb(54, 162, 235)' }, ticks: { color: 'rgb(54, 162, 235)' }, grid: { drawOnChartArea: false }, } } } }); };
    updateDateTime = () => { const now = new Date(); const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }; dateTimeEl.textContent = now.toLocaleDateString('zh-TW', options); };
    callGemini = async (prompt, title) => { geminiModal.classList.remove('hidden'); geminiContent.innerHTML = `<div class="flex justify-center items-center"><div class="spinner"></div></div><p class="mt-4 text-gray-600 font-medium">âœ¨ Gemini æ­£åœ¨ç‚ºæ‚¨åˆ†æ...</p>`; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: prompt }] }] }; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API è«‹æ±‚å¤±æ•—`); const result = await response.json(); const suggestion = result.candidates[0].content.parts[0].text; geminiContent.innerHTML = `<h3 class="text-lg font-bold text-gray-800 mb-3">${title}</h3><p class="text-gray-700 text-left">${suggestion.replace(/\n/g, '<br>')}</p>`; } catch (error) { console.error("Gemini API Error:", error); geminiContent.innerHTML = `<h3 class="text-lg font-bold text-red-600 mb-3">å‡ºéŒ¯äº†</h3><p class="text-gray-700">ç„¡æ³•ç²å–åˆ†æçµæœï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`; } };
    getGeminiSuggestion = () => { const prompt = `ä½ æ˜¯ä¸€å€‹æ™ºèƒ½å®¶å±…åŠ©æ‰‹ã€‚è«‹æ ¹æ“šç•¶å‰å®¤å…§æº«åº¦ç‚º ${currentTemp}Â°Cï¼Œæ¿•åº¦ç‚º ${currentHumidity}% çš„æƒ…æ³ï¼Œç”¨ç¹é«”ä¸­æ–‡æä¾›ä¸€æ¢ç°¡æ½”ã€å‹å¥½ã€å¯¦ç”¨çš„å»ºè­°ã€‚å»ºè­°å…§å®¹å¯ä»¥é—œæ–¼å¥åº·ã€èˆ’é©åº¦ã€æ´»å‹•æˆ–ç©¿è‘—ã€‚è«‹å°‡å›è¦†é™åˆ¶åœ¨50å€‹å­—ä»¥å…§ï¼Œä¸¦ä¸”èªæ°£è¦è¦ªåˆ‡ã€‚`; callGemini(prompt, 'âœ¨ æ™ºèƒ½å»ºè­°'); };
    getGeminiTrendAnalysis = () => { if (historyChart.data.datasets[0].data.length < 3) { geminiModal.classList.remove('hidden'); geminiContent.innerHTML = `<h3 class="text-lg font-bold text-gray-800 mb-3">è³‡æ–™ä¸è¶³</h3><p class="text-gray-700">éœ€è¦æ›´å¤šæ­·å²æ•¸æ“šæ‰èƒ½é€²è¡Œåˆ†æï¼Œè«‹ç¨å¾…ç‰‡åˆ»ã€‚</p>`; return; } const dataString = historyChart.data.datasets[0].data.map((temp, index) => `(${historyChart.data.labels[index]}: ${temp}Â°C, ${historyChart.data.datasets[1].data[index]}%)`).join(', '); const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ•¸æ“šåˆ†æå¸«å’Œæ™ºèƒ½å®¶å±…é¡§å•ã€‚è«‹æ ¹æ“šä»¥ä¸‹å®¤å…§æº«æ¿•åº¦æ•¸æ“šåºåˆ—ï¼Œç”¨ç¹é«”ä¸­æ–‡é€²è¡Œåˆ†æã€‚æ•¸æ“šæ ¼å¼ç‚º (æ™‚é–“: æº«åº¦, æ¿•åº¦)ã€‚æ•¸æ“š: ${dataString}ã€‚è«‹æä¾›ä¸€å€‹ç°¡æ½”ã€æ¢ç†åˆ†æ˜çš„æ‘˜è¦ï¼ŒåŒ…å«ï¼š1. **æ•´é«”è¶¨å‹¢**ã€‚2. **èˆ’é©åº¦åˆ†æ**ã€‚3. **å¯¦ç”¨å»ºè­°**ã€‚ç¸½é•·åº¦åœ¨100å­—å·¦å³ã€‚`; callGemini(prompt, 'âœ¨ æ­·å²è¶¨å‹¢åˆ†æ'); };

    function updateChart(label, newTemp, newHumidity) {
        if (!isLiveMode) return;
        const labels = historyChart.data.labels;
        const tempData = historyChart.data.datasets[0].data;
        const humidityData = historyChart.data.datasets[1].data;
        labels.push(label);
        tempData.push(newTemp);
        humidityData.push(newHumidity);
        if (labels.length > 12) {
            labels.shift();
            tempData.shift();
            humidityData.shift();
        }
        updateChartScales(historyChart, tempData, humidityData);
        historyChart.update('none');
    }

    function onNewDataReceived(data) {
        console.log("æ”¶åˆ°æ–°æ•¸æ“š:", data);
        if (data && typeof data.temp1 === 'number' && typeof data.rh1 === 'number') {
            currentTemp = parseFloat(data.temp1.toFixed(1));
            currentHumidity = Math.round(data.rh1);
            currentTempEl.textContent = currentTemp.toFixed(1);
            currentHumidityEl.textContent = currentHumidity;
            updateAppearance(currentTemp);
            const timeLabel = new Date(data.timestamp || Date.now()).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            updateChart(timeLabel, currentTemp, currentHumidity);
        } else {
            console.error("æ”¶åˆ°çš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º:", data);
        }
    }

    async function fetchAndDisplayHistory(timespan) {
        isLiveMode = false;
        statusTextEl.textContent = `æ­£åœ¨æŸ¥è©¢éå» ${timespan === 'hour' ? '1' : '24'} å°æ™‚æ•¸æ“š...`;
        try {
            const response = await fetch(`${FUNCTION_APP_URL}/api/getHistory?timespan=${timespan}`);
            if (!response.ok) throw new Error(`ç²å–æ­·å²æ•¸æ“šå¤±æ•—: ${response.statusText}`);
            const data = await response.json();
            historyChart.data.labels = [];
            historyChart.data.datasets[0].data = [];
            historyChart.data.datasets[1].data = [];
            data.forEach(d => {
                historyChart.data.labels.push(new Date(d.timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }));
                historyChart.data.datasets[0].data.push(d.temp1);
                historyChart.data.datasets[1].data.push(d.rh1);
            });
            updateChartScales(historyChart, historyChart.data.datasets[0].data, historyChart.data.datasets[1].data);
            historyChart.update();
            statusTextEl.textContent = `é¡¯ç¤ºéå» ${timespan === 'hour' ? '1' : '24'} å°æ™‚æ•¸æ“š`;
        } catch (error) {
            console.error("ç²å–æ­·å²æ•¸æ“šæ™‚å‡ºéŒ¯:", error);
            statusTextEl.textContent = "æŸ¥è©¢æ­·å²æ•¸æ“šå¤±æ•—";
        }
    }

    async function setupSignalR() {
        const negotiateUrl = `${FUNCTION_APP_URL}/api/negotiate`;
        try {
            const negotiateResponse = await fetch(negotiateUrl, { method: "POST" });
            if (!negotiateResponse.ok) throw new Error(`Negotiate è«‹æ±‚å¤±æ•—`);
            const connectionInfo = await negotiateResponse.json();
            const connection = new signalR.HubConnectionBuilder()
                .withUrl(connectionInfo.url, { accessTokenFactory: () => connectionInfo.accessToken })
                .withAutomaticReconnect()
                .build();
            connection.on('temp-update', onNewDataReceived);
            await connection.start();
            statusTextEl.textContent = "å·²é€£æ¥åˆ°æ„Ÿæ‡‰å™¨";
        } catch (err) {
            console.error("SignalR é€£æ¥å¤±æ•—: ", err);
            statusTextEl.textContent = "æ„Ÿæ‡‰å™¨é€£æ¥å¤±æ•—";
        }
    }

    // --- äº‹ä»¶ç›£è½ ---
    geminiBtn.addEventListener('click', getGeminiSuggestion);
    geminiTrendBtn.addEventListener('click', getGeminiTrendAnalysis);
    closeModalBtn.addEventListener('click', () => geminiModal.classList.add('hidden'));
    geminiModal.addEventListener('click', (e) => { if (e.target === geminiModal) { geminiModal.classList.add('hidden'); } });

    historyControls.addEventListener('click', (e) => {
        if (e.target.classList.contains('history-btn')) {
            historyControls.querySelectorAll('.history-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            const timespan = e.target.dataset.timespan;
            if (timespan) {
                fetchAndDisplayHistory(timespan);
            }
        }
    });

    liveBtn.addEventListener('click', () => {
        isLiveMode = true;
        statusTextEl.textContent = "å·²é€£æ¥åˆ°æ„Ÿæ‡‰å™¨";
        historyChart.data.labels = [];
        historyChart.data.datasets.forEach(dataset => dataset.data = []);
        historyChart.update();
    });


    // --- åˆå§‹åŒ– ---
    window.onload = () => {
        setupChart(); 
        updateAppearance(currentTemp); 
        updateDateTime();
        setupSignalR();
        setInterval(updateDateTime, 60000);
    };
</script>

</body>
</html>
