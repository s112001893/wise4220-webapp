<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智能溫濕度計</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .temp-gradient-text { background-clip: text; -webkit-background-clip: text; color: transparent; }
        .chart-container { position: relative; height: 180px; width: 100%; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen">

    <!-- 手機螢幕模擬 -->
    <div class="w-full max-w-sm h-[85vh] max-h-[800px] min-h-[680px] mx-auto bg-gray-50 rounded-3xl shadow-2xl overflow-hidden flex flex-col">
        
        <main id="main-container" class="flex flex-col h-full transition-all duration-1000 ease-in-out">
            
            <!-- 頂部標題 (固定高度) -->
            <header class="p-6 flex justify-between items-center flex-shrink-0">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">我的房間</h1>
                    <p id="date-time" class="text-sm text-gray-500">正在載入日期...</p>
                </div>
                <div class="w-10 h-10 bg-white/50 rounded-full flex items-center justify-center shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </div>
            </header>

            <!-- 即時數據顯示 (彈性填滿剩餘空間) -->
            <section class="flex-grow flex flex-col items-center justify-center text-center px-6">
                <div id="temp-display" class="relative w-48 h-48 rounded-full flex items-center justify-center shadow-inner transition-all duration-1000 ease-in-out flex-shrink-0">
                    <div class="absolute inset-0 rounded-full shadow-xl"></div>
                    <div class="z-10">
                        <p class="font-bold text-6xl temp-gradient-text" id="current-temp">--.-</p>
                        <p class="font-medium text-lg text-gray-600">°C</p>
                    </div>
                </div>

                <div class="mt-8 text-lg font-medium text-gray-700">
                    <p>濕度: <span id="current-humidity" class="font-bold">--</span>%</p>
                </div>
                 <div class="mt-2 text-sm text-gray-500">
                    <p id="status-text">正在連接感應器...</p>
                </div>
                
                <div class="mt-6">
                    <button id="gemini-btn" class="px-6 py-2 bg-white/80 backdrop-blur-sm text-gray-700 font-semibold rounded-full shadow-md hover:bg-white transition-all transform hover:scale-105">
                        ✨ 獲取智能建議
                    </button>
                </div>
            </section>

            <!-- 歷史數據圖表 (固定高度) -->
            <section class="p-6 pt-0 flex-shrink-0">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-gray-800">歷史數據</h2>
                    <button id="gemini-trend-btn" class="px-4 py-1 text-xs bg-white/70 backdrop-blur-sm text-gray-600 font-semibold rounded-full shadow-sm hover:bg-white transition-all">
                        ✨ 分析趨勢
                    </button>
                </div>
                <div class="p-4 bg-white/60 rounded-2xl shadow-md backdrop-blur-sm">
                    <div class="chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Gemini 建議模態框 -->
    <div id="gemini-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white/90 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center">
            <div id="gemini-content"></div>
            <button id="close-modal-btn" class="mt-6 bg-gray-200 text-gray-700 px-8 py-2 rounded-full font-semibold hover:bg-gray-300 transition-all">關閉</button>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const FUNCTION_APP_URL = 'https://my-temp-hub-functions-2025.azurewebsites.net'; 
    // --- END CONFIGURATION ---

    // --- DOM 元素 ---
    const mainContainer = document.getElementById('main-container');
    const tempDisplay = document.getElementById('temp-display');
    const currentTempEl = document.getElementById('current-temp');
    const currentHumidityEl = document.getElementById('current-humidity');
    const statusTextEl = document.getElementById('status-text');
    const dateTimeEl = document.getElementById('date-time');
    const geminiBtn = document.getElementById('gemini-btn');
    const geminiTrendBtn = document.getElementById('gemini-trend-btn');
    const geminiModal = document.getElementById('gemini-modal');
    const geminiContent = document.getElementById('gemini-content');
    const closeModalBtn = document.getElementById('close-modal-btn');

    let historyChart;
    let currentTemp = 25.3;
    let currentHumidity = 58;
    let tempData = [];
    let humidityData = [];
    let timeLabels = [];

    // --- 核心功能 ---

    function updateAppearance(temp) {
        let bgColor, shadowColor, gradientFrom, gradientTo, statusText;
        const tempMin = 15, tempMax = 35, hueMin = 220, hueMax = 0;
        const clampedTemp = Math.max(tempMin, Math.min(tempMax, temp));
        const tempRatio = (clampedTemp - tempMin) / (tempMax - tempMin);
        const hue = hueMin - (hueMin - hueMax) * tempRatio;
        const lightness = temp > 28 ? 85 : 95;
        const saturation = temp > 28 ? 65 : 60;
        
        bgColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        shadowColor = `hsl(${hue}, ${saturation-10}%, ${lightness-10}%)`;
        gradientFrom = `hsl(${hue}, 80%, 60%)`;
        gradientTo = `hsl(${(hue + 30) % 360}, 80%, 50%)`;
        
        if (temp > 30) statusText = "有點熱";
        else if (temp > 28) statusText = "天氣溫暖";
        else if (temp < 18) statusText = "有點涼";
        else statusText = "體感舒適";

        mainContainer.style.backgroundColor = bgColor;
        tempDisplay.style.backgroundColor = `hsl(${hue}, ${saturation}%, 98%)`;
        tempDisplay.style.boxShadow = `0 0 40px ${shadowColor}`;
        currentTempEl.style.backgroundImage = `linear-gradient(45deg, ${gradientFrom}, ${gradientTo})`;
        statusTextEl.textContent = statusText;
    }

    function updateChartScales(chart, tempData, humidityData) {
        if (tempData.length < 2) return;
        const tempMin = Math.min(...tempData);
        const tempMax = Math.max(...tempData);
        const humidityMin = Math.min(...humidityData);
        const humidityMax = Math.max(...humidityData);
        const tempPadding = (tempMax - tempMin) * 0.2 || 0.5;
        const humidityPadding = (humidityMax - humidityMin) * 0.2 || 2;
        chart.options.scales.y_temp.min = Math.floor(tempMin - tempPadding);
        chart.options.scales.y_temp.max = Math.ceil(tempMax + tempPadding);
        chart.options.scales.y_humidity.min = Math.floor(humidityMin - humidityPadding);
        chart.options.scales.y_humidity.max = Math.ceil(humidityMax + humidityPadding);
    }

    function updateChart(chart, label, newTemp, newHumidity) {
        const dataset0 = chart.data.datasets[0].data;
        const dataset1 = chart.data.datasets[1].data;
        
        chart.data.labels.push(label);
        dataset0.push(newTemp);
        dataset1.push(newHumidity);

        if (chart.data.labels.length > 12) {
            chart.data.labels.shift();
            dataset0.shift();
            dataset1.shift();
        }
        
        updateChartScales(chart, dataset0, dataset1);
        chart.update('none');
    }

    function setupChart() {
        const ctx = document.getElementById('historyChart').getContext('2d');
        historyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: '溫度 (°C)', data: tempData, borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    fill: true, tension: 0.4, yAxisID: 'y_temp',
                }, {
                    label: '濕度 (%)', data: humidityData, borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true, tension: 0.4, yAxisID: 'y_humidity',
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                scales: {
                    x: { grid: { display: false } },
                    y_temp: {
                        type: 'linear', display: true, position: 'left',
                        title: { display: true, text: '溫度 (°C)', color: 'rgb(255, 99, 132)' },
                        ticks: { color: 'rgb(255, 99, 132)' }
                    },
                    y_humidity: {
                        type: 'linear', display: true, position: 'right',
                        title: { display: true, text: '濕度 (%)', color: 'rgb(54, 162, 235)' },
                        ticks: { color: 'rgb(54, 162, 235)' },
                        grid: { drawOnChartArea: false },
                    }
                }
            }
        });
    }
    
    function updateDateTime() {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        dateTimeEl.textContent = now.toLocaleDateString('zh-TW', options);
    }

    async function callGemini(prompt, title) {
        geminiModal.classList.remove('hidden');
        geminiContent.innerHTML = `<div class="flex justify-center items-center"><div class="spinner"></div></div><p class="mt-4 text-gray-600 font-medium">✨ Gemini 正在為您分析...</p>`;
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API 請求失敗`);
            const result = await response.json();
            const suggestion = result.candidates[0].content.parts[0].text;
            geminiContent.innerHTML = `<h3 class="text-lg font-bold text-gray-800 mb-3">${title}</h3><p class="text-gray-700 text-left">${suggestion.replace(/\n/g, '<br>')}</p>`;
        } catch (error) {
            console.error("Gemini API Error:", error);
            geminiContent.innerHTML = `<h3 class="text-lg font-bold text-red-600 mb-3">出錯了</h3><p class="text-gray-700">無法獲取分析結果，請稍後再試。</p>`;
        }
    }

    function getGeminiSuggestion() {
        const prompt = `你是一個智能家居助手。請根據當前室內溫度為 ${currentTemp}°C，濕度為 ${currentHumidity}% 的情況，用繁體中文提供一條簡潔、友好、實用的建議。建議內容可以關於健康、舒適度、活動或穿著。請將回覆限制在50個字以內，並且語氣要親切。`;
        callGemini(prompt, '✨ 智能建議');
    }

    function getGeminiTrendAnalysis() {
        if (tempData.length < 3) {
            geminiModal.classList.remove('hidden');
            geminiContent.innerHTML = `<h3 class="text-lg font-bold text-gray-800 mb-3">資料不足</h3><p class="text-gray-700">需要更多歷史數據才能進行分析，請稍待片刻。</p>`;
            return;
        }
        const dataString = tempData.map((temp, index) => `(${timeLabels[index]}: ${temp}°C, ${humidityData[index]}%)`).join(', ');
        const prompt = `你是一位專業的數據分析師和智能家居顧問。請根據過去一小時內的以下室內溫濕度數據序列，用繁體中文進行分析。數據格式為 (時間: 溫度, 濕度)。數據: ${dataString}。

請提供一個簡潔、條理分明的摘要，包含以下幾點：
1.  **整體趨勢**：明確指出溫度和濕度的主要變化趨勢。
2.  **舒適度分析**：根據這個趨勢，分析對人體舒適度的影響。
3.  **實用建議**：基於分析結果，提供一條具體的建議。

請讓回覆專業、易於理解，總長度在100字左右。`;
        callGemini(prompt, '✨ 歷史趨勢分析');
    }

    function onNewDataReceived(data) {
        console.log("收到新數據:", data);
        if (data && typeof data.temp1 === 'number' && typeof data.rh1 === 'number') {
            currentTemp = parseFloat(data.temp1.toFixed(1));
            currentHumidity = Math.round(data.rh1);
            currentTempEl.textContent = currentTemp.toFixed(1);
            currentHumidityEl.textContent = currentHumidity;
            updateAppearance(currentTemp);
            const timeLabel = new Date(data.timestamp || Date.now()).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            updateChart(historyChart, timeLabel, currentTemp, currentHumidity);
        } else {
            console.error("收到的數據格式不正確:", data);
        }
    }

    async function setupSignalR() {
        const negotiateUrl = `${FUNCTION_APP_URL}/api/negotiate`;
        try {
            const negotiateResponse = await fetch(negotiateUrl, { method: "POST" });
            if (!negotiateResponse.ok) throw new Error(`Negotiate 請求失敗`);
            const connectionInfo = await negotiateResponse.json();
            const connection = new signalR.HubConnectionBuilder()
                .withUrl(connectionInfo.url, { accessTokenFactory: () => connectionInfo.accessToken })
                .withAutomaticReconnect()
                .build();
            connection.on('temp-update', onNewDataReceived);
            await connection.start();
            statusTextEl.textContent = "已連接到感應器";
        } catch (err) {
            console.error("SignalR 連接失敗: ", err);
            statusTextEl.textContent = "感應器連接失敗";
        }
    }

    // --- 事件監聽 ---
    geminiBtn.addEventListener('click', getGeminiSuggestion);
    geminiTrendBtn.addEventListener('click', getGeminiTrendAnalysis);
    closeModalBtn.addEventListener('click', () => geminiModal.classList.add('hidden'));
    geminiModal.addEventListener('click', (e) => {
        if (e.target === geminiModal) {
            geminiModal.classList.add('hidden');
        }
    });

    // --- 初始化 ---
    window.onload = () => {
        setupChart(); 
        updateAppearance(currentTemp); 
        updateDateTime();
        setupSignalR();
        setInterval(updateDateTime, 60000);
    };
</script>

</body>
</html>
